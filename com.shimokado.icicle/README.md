# WebFOCUS D3.js つららチャート拡張機能

D3.js を使用してつららチャート（Icicle Chart / 階層型矩形図）を表示する拡張機能です。階層データを矩形のサイズと配置で視覚化し、データの構造と値を直感的に表現します。
本拡張機能は、左から右へ階層が深くなる「横向きレイアウト」を採用しています。

## 主な機能

- **つららチャート表示**: D3.js ライブラリを使用した階層型矩形図の表示
- **横向きレイアウト**: 左（ルート）から右（詳細）へ展開される見やすい配置
- **階層構造の視覚化**:
  - データの階層関係を矩形のサイズと配置で表現
  - 複数階層のサポート（1～5階層）
- **D3.jsベースの視覚化**:
  - D3 v7 対応
  - インタラクティブな表示
  - レスポンシブ対応
- **柔軟なラベル設定**: ディメンションとメジャーの両方に対応
- **データ選択対応**: WebFOCUSのデータ選択機能をサポート
- **カスタムツールチップ**:
  - D3.jsによる独自実装
  - 階層パスと値を表示
  - マウス追従型（カーソルと重ならないよう配置調整済み）
  - データバケットのタイトルを動的に表示

## データ要件

この拡張機能には以下のデータバケットが必要です：

- **値** (メジャー): 表示する数値データ（矩形のサイズを決定）
  - 最小: 1
  - 最大: 1
- **ラベル** (ディメンション/メジャー): 階層構造を形成するラベル群
  - 最小: 1
  - 最大: 5
  - 注意: 階層の深さに応じて1～5個のラベルを設定可能

## プロパティ設定

以下のプロパティをWebFOCUS Designerで設定できます：

- **chartHeadroom** (数値): チャート上部の余白（ピクセル単位、デフォルト: 50）
- **external_library** (文字列): D3.jsライブラリのURL（デフォルト: "lib/d3.min.js"）
- **tableStyle** (オブジェクト):
  - **fontSize** (文字列): フォントサイズ（デフォルト: "20px"）
  - **color** (文字列): テキストカラー（デフォルト: "#663300"）

## 使用方法

1. WebFOCUS Designerで新しいレポートを作成
2. チャートタイプとして「つららチャート」を選択
3. データバケットに以下のフィールドを割り当て：
   - **値**: 数値フィールド（矩形サイズ）
   - **ラベル**: 階層を形成するフィールド（1～5個）
4. 必要に応じてプロパティを調整
5. レポートを実行してチャートを表示

## 実装の特徴

- **データ正規化**: `depth` パラメータに応じたデータ構造の統一処理
- **階層データ構築**: フラットデータをD3.jsの階層構造に変換
- **パーティションレイアウト**: D3.jsのpartitionレイアウトを使用した矩形分割（横向き設定）
- **色設定**: WebFOCUSの配色設定を尊重した自動色付け
- **ツールチップ**: D3.jsイベントハンドラによるカスタム実装（v7対応）

## ファイルの説明

### com.shimokado.icicle.js
グラフモジュールの本体。D3.jsを使用したつららチャートの描画ロジックを実装。

### properties.json
拡張グラフの設定ファイル。データバケット定義、プロパティ設定、多言語対応を含む。

### icons/icon.png
グラフ選択で表示されるアイコン画像。

### lib/d3.min.js
D3.js ライブラリファイル。

### css/style.css
スタイルシートファイル。

### test.html（テスト用ファイル、デプロイ不要）
ローカルでモジュールをテストするためのHTMLファイル。WebFOCUSにデプロイする必要はない。

### tdgchart-min-for-test.js（テスト用ファイル、デプロイ不要）
ローカルでモジュールをテストするためにtdgchart-min.jsを加工したjsファイル。WebFOCUSにデプロイする必要はない。

## ライセンス

Copyright (C) 2025. Shimokado Masataka. All rights reserved.

## 関連ドキュメント

- [WebFOCUS拡張グラフ開発ガイド](../../development_guide/)
- [チュートリアル](../../tutorial/)
