# WebFOCUS公式マニュアル詳細 (日本語)

## 1. 拡張グラフの作成 (Creating a WebFOCUS Extension)

WebFOCUS拡張グラフは、独自の可視化ロジックをWebFOCUSに統合するためのAPIです。

- **ディレクトリ構造**: 拡張グラフは特定のディレクトリ構造（`com.company.chart` など）を持つ必要があります。
- **必須ファイル**: メインJSファイルと `properties.json` が必須です。
- **登録**: `tdgchart.extensionManager.register()` を使用して登録します。

## 2. プロパティ設定 (Editing Extension Configuration)

`properties.json` で拡張グラフの振る舞いを制御します。

- **info**: 拡張グラフのメタデータ。
- **properties**: ユーザーが変更可能な設定値（色、フォントサイズなど）。
- **propertyAnnotations**: プロパティの型情報。WebFOCUSのGUIで適切な入力コントロールを表示するために使用されます。
- **translations**: 多言語対応。

## 3. データインターフェース (Editing Extension Data Interface)

WebFOCUSから拡張グラフへのデータの渡し方を定義します。

- **Data Buckets**: データの「受け皿」を定義します。
  - `buckets`: バケットの配列。
  - `id`: バケットのID（プログラムから参照）。
  - `type`: `measure`（数値）または `dimension`（属性）。
  - `count`: 受け入れるフィールドの数（min/max）。

## 4. ライフサイクルメソッド

拡張グラフは以下のコールバックを通じて制御されます。

- **initCallback**: 初期化時（1回のみ）。
- **preRenderCallback**: 描画前。
- **renderCallback**: 描画時（メイン）。
- **noDataRenderCallback**: データがない場合の描画。

## 5. ベストプラクティス

- **名前空間**: グローバルスコープを汚染しないよう、即時関数 `(function(){ ... })();` で囲むこと。
- **レスポンシブ**: `renderConfig.width` と `renderConfig.height` を使用して、コンテナサイズに合わせて描画すること。
- **エラー処理**: 予期せぬデータやエラーに対して適切に処理し、必要に応じてエラーメッセージを表示すること。

## 6. Chart Extension API の詳細 (Using the Chart Extension API)

### 6.1 チャートのレンダリング (Rendering Charts)

拡張APIは、必要に応じて定義できる3つのエントリポイントを提供します。これらはconfigオブジェクトにプロパティのセットを渡されます。一部のプロパティはレンダリングプロセス全体で利用可能で、一部はrenderCallback中のみ利用可能です。

#### 6.1.1 チャートレンダリングコールバック関数 (Chart Rendering Callback Functions)

以下の3つのJavaScriptコールバック関数を定義できます。renderCallback関数のみが常に必須です。

- **initCallback(successCallback, config)**: このオプション関数は、ライブラリロード時にエンジンによって正確に1回呼び出されます。document.onload初期化コードを実装する方法を提供します。この関数はsuccessCallbackを渡され、初期化コードが成功した場合はtrue、失敗した場合はfalseで呼び出す必要があります。successCallback(false)を呼び出すと、拡張機能とのさらなる相互作用は発生せず、拡張機能は空のページとしてレンダリングされます。
- **preRenderCallback(config)**: このオプション関数は、拡張機能がレンダリングされるたびに、レンダリングプロセスの最初のステップとして呼び出されます。これは、後続のレンダリングに影響する内部チャートプロパティを調べ、調整、またはオーバーライドするのに適した場所です。
- **renderCallback(config)**: この必須関数には、チャートを実際に描画するすべてのコードを含める必要があります。configオブジェクトには、以下のセクションで説明するプロパティが含まれます。

#### 6.1.2 常に利用可能なプロパティ (Properties That Are Always Available)

以下のプロパティは常に利用可能です。

| プロパティ | 説明 |
| --- | --- |
| moonbeamInstance | 現在レンダリング中のチャートインスタンス。 |
| data | レンダリング中のデータセット。 |
| properties | ユーザーによって設定された拡張機能のプロパティブロック。 |

#### 6.1.3 renderCallback中のみ利用可能なプロパティ (Properties Available Only During Render Callback)

以下のプロパティはrenderCallback中のみ利用可能で、チャートレンダリングコードで使用されます。

| プロパティ | 説明 |
| --- | --- |
| width | 拡張機能がレンダリングされるコンテナの幅（ピクセル単位）。 |
| height | 拡張機能がレンダリングされるコンテナの高さ（ピクセル単位）。 |
| containerIDPrefix | 拡張機能がレンダリングされるDOMコンテナのID。拡張機能が生成するすべてのIDの前にこれを付加し、1ページ上で拡張機能の複数のコピーが動作することを保証します。 |
| container | 拡張機能がレンダリングされるDOMノード。HTML DIV要素またはSVG G要素（containerType拡張設定による）。 |
| rootContainer | レンダリング中の特定のチャートエンジンインスタンスを含むDOMノード。 |

### 6.2 拡張機能の設定 (Configuring Your Chart Extension)

拡張機能の設定は2つの部分からなります。

- **チャートエンジン設定**: WebFOCUSのチャートエンジンとチャートキャンバスと相互作用するように拡張機能を設定します。この部分は、チャートレンダラー関数に渡されるconfigオブジェクトで定義されます。
- **チャートインターフェース設定**: ユーザーインターフェースのチャートタイプピッカーとチャート属性カテゴリと相互作用します。この部分はproperties.jsonファイルで定義されます。

#### 6.2.1 configオブジェクトの作成 (Creating a config Object for Chart Engine Configuration)

拡張機能を設定するには、拡張機能に固有のすべての情報を含むconfigオブジェクトを作成し、拡張APIに拡張機能を登録します。

必須およびオプションのプロパティは以下の表に記載されています。

| プロパティ | 説明 |
| --- | --- |
| id | Extension Structureで説明されている拡張ID。 |
| name | ユーザーインターフェースに表示されるチャートタイプの名前。 |
| description | ユーザーインターフェースに表示されるチャートタイプの説明。 |
| containerType | 'html' または 'svg'（デフォルト）。 |
| initCallback | オプション。Chart Renderingで説明されているinitCallback関数への参照。 |
| preRenderCallback | オプション。Chart Renderingで説明されているpreRenderCallback関数への参照。 |
| renderCallback | 必須。Chart Renderingで説明されているrenderCallback関数への参照。 |
| resources | オプション。この拡張機能が必要とする追加の外部リソース（CSSおよびJS）。 |

#### 6.2.2 拡張機能の登録 (Registering Your Extension)

拡張機能をWebFOCUS拡張APIに登録するには、以下を呼び出します：

```javascript
tdgchart.extensionManager.register(config);
```

#### 6.2.3 拡張機能構築のヒント (Tips for Building Your Extension)

独自の拡張機能を構築する最も簡単な方法は、Simple Barの例をクローンし、それを調整することです。新しい拡張機能のIDがcom.foo.barであると仮定します：

1. ルートフォルダをcom.foo.barに名前変更します。com.ibi.simple_bar.jsをcom.foo.bar.jsに名前変更します。
2. com.foo.bar.jsで、3つのコールバック関数の内部コンテンツを削除します。
3. com.foo.bar.jsで、configの各プロパティのエントリを拡張機能の要件に合わせて変更します。
4. 必要な外部リソースをlibおよびcssに追加し、com.foo.bar.jsのconfig.resourcesを設定してロードします。
5. com.foo.bar.jsでrenderCallbackを実装して拡張機能を描画します。

#### 6.2.4 チャートインターフェースの設定 (Configuring the Chart Interface)

各拡張機能にはproperties.jsonファイルを含める必要があります。これはWebFOCUSがユーザーインターフェースを描画する際に必要な情報を定義します。

properties.jsonファイルは以下のブロックからなります。

- **infoブロック**: 一般的な構成オプションを定義します。
- **propertiesブロック**: エンドユーザーが変更したい拡張機能のプロパティを定義します。
- **propertyAnnotationsブロック**: propertiesブロックの内容を検証します。
- **dataBucketsブロック**: WebFOCUSのQueryペインに表示されるチャート属性カテゴリのセットを定義します。
- **translationsブロック**: WebFOCUSインターフェースに描画されるすべてのラベルの翻訳を定義します。

### 6.3 データへのアクセス (Accessing Data for Your Extension)

拡張機能がレンダリングされるたびに、renderCallbackの最初の引数であるrenderConfigのdataプロパティを使用して、現在のデータセットが拡張機能に渡されます。renderConfig.dataBucketsには、各バケットの現在のフィールドセットに関する追加情報が含まれます。

#### 6.3.1 拡張機能でのバケットの定義と使用 (Defining and Using Buckets in an Extension)

データセットはJavaScriptのオブジェクトの配列として表現されます。拡張機能がカスタムバケットのみを定義する場合、データセットはオブジェクトのフラット配列になります。拡張機能が一部の組み込みバケットを使用する場合、データセットには深くネストされた配列の配列が含まれる場合があります。renderConfig.dataBuckets.depthプロパティは、現在のデータセットの配列次元の数を設定します。

##### カスタムバケット (Custom Buckets)

データ内の最も内側の各オブジェクト（datumと呼ばれる）には、フィールドを含む各データバケットに対して1つのプロパティがあります。各プロパティはproperties.jsonのdataBuckets.bucketsセクションで定義されたカスタムバケットのidになります。これらのプロパティの値の型はバケットタイプによって異なります。ディメンションバケットは文字列値を持ち、メジャーバケットは数値を持ちます。バケットに複数のフィールドが含まれる場合、各最も内側のオブジェクトの関連プロパティは文字列または数値の配列になります。

##### 組み込みバケット (Built-in Buckets)

拡張機能はWebFOCUSによって事前定義された組み込みバケットを使用できます。これらのバケットはデータセットだけでなく、特定のチャートエンジンプロパティも設定し、そのバケットに関連する追加情報を渡します。

各組み込みWebFOCUSバケットは、標準バケットまたはブレークバケットのいずれかです。

- **標準バケット**: カスタムバケットとまったく同じように動作します。データセットは単一の配列のままになり、各datumオブジェクトにはバケットにちなんで名付けられた追加のプロパティが含まれます。
- **ブレークバケット**: データセットを追加のデータ配列に分割します。各ブレークバケットに対して、各datumオブジェクトは完全なdatumオブジェクトの配列に変換されます。各配列内のdatumオブジェクトの数は変更されませんが、配列またはdatum配列の数はブレークフィールドのエントリ数に対応します。

##### ブレークバケットのタイプ (Types of Break Buckets)

ブレークバケットには2つのタイプがあります：

- **シリーズブレークバケット**: シリーズブレークフィールドの各エントリに対してデータセットを1つの配列に分割します。シリーズブレークバケットはチャートエンジンで定義されたシリーズ依存プロパティを使用し、データ名はそれらのシリーズ依存プロパティにリストされます。シリーズブレークフィールドの各エントリは、renderConfig.moonbeamInstance.getSeries(x)で取得できる対応するシリーズプロパティオブジェクトを生成します。ここでxは取得するシリーズの整数です。getSeriesは、選択されたシリーズに固有のcolorやlabelなどのプロパティを持つオブジェクトを返します。
- **マトリックスブレークバケット**: マトリックスチャートの列と行を定義するソートフィールドに使用されます。マトリックスブレークバケットもデータセットに追加の配列次元を追加します。マトリックスブレークバケットは列と行のサブバケットに分割されます。行または列バケットのいずれかにフィールドが含まれる場合、データセットには2つの追加次元のデータが含まれます。bucket.depthは常に少なくとも3になります。

##### ツールチップバケット (The Tooltip Bucket)

ツールチップバケットはブレークバケットではなく、データセットに追加の配列次元を追加しません。代わりに、ツールチップはカスタムバケットのように動作します。各内側のdatumオブジェクトにはtooltipという名前のプロパティが含まれ、値はディメンションの場合は文字列、メジャーの場合は数値、複数のフィールドの場合は値の配列になります。

このバケットの有用性は、ツールチップ固有のデータをデータセットに含めるだけでなく、WebFOCUSが各シリーズに対して意味のあるツールチップコンテンツを生成することです。このツールチップコンテンツは、すべての組み込みWebFOCUSチャートタイプで使用されるものと同じです。ツールチップバケットを使用することで、拡張機能は各ツールチップに何を入れるべきかを考える必要がありません。

#### 6.3.2 拡張機能での部分データとnullデータの処理 (Handling Partial and Null Data in an Extension)

多くの場合、エンドユーザーは拡張機能のすべてのバケットをすぐに埋めることができません。拡張機能はこれらの部分データケースを正しく処理しなければならず、1つ以上のバケットが空の場合にクラッシュしてはいけません。renderConfig.dataBucketsをチェックしてどのバケットが埋められたかを確認し、それに応じて動作することが重要です。

さらに、データセットはしばしば不完全で、特定のディメンションとメジャーの組み合わせで一部の値が欠けています。これらの欠損値は、配列内のnullエントリとして（datumオブジェクトの代わりに）、または完全に空の配列としてデータセットに現れる場合があります。これらの欠損データケースを検出し、適切に処理し、そのような欠損データに適した視覚化をレンダリングすることが重要です。

ほとんどの拡張機能は、何かがレンダリングされる前に埋められたバケットの最小数を必要とします。properties.jsonの各dataBuckets.bucketエントリのcount.minプロパティを使用して、これらの最小要件を定義します。すべてのバケットのフィールドが最小カウントを満たさない場合、拡張機能のrenderCallbackは呼び出されません。代わりに、拡張機能のnoDataPreRenderCallbackが呼び出されます。これにより、拡張機能は特別なノーデータモードでレンダリングできます。このモードでは、拡張機能はグレースケールでレンダリングし、renderCallback.baseColorをメインカラーとして使用する必要があります。これは、拡張機能の非常に簡略化された、サンプルレンダリングであるべきです。
